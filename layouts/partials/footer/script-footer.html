{{ $indexTemplate := resources.Get "js/index.js" -}}
{{ $index := $indexTemplate | resources.ExecuteAsTemplate "index.js" . -}}

{{ $bs := resources.Get "js/bootstrap.js" -}}
{{ $bs := $bs | js.Build -}}

{{ $highlight := resources.Get "js/highlight.js" -}}
{{ $highlight := $highlight | js.Build -}}

{{ $katex := resources.Get "js/vendor/katex/dist/katex.js" -}}
{{ $katexAutoRender := resources.Get "js/vendor/katex/dist/contrib/auto-render.js" -}}

{{ $mermaid := resources.Get "js/mermaid.js" | js.Build -}}

{{ $app := resources.Get "js/app.js" -}}

{{ $slice := slice $app -}}

{{ if .Site.Params.options.lazySizes -}}
  {{ $lazySizes := resources.Get "js/lazysizes.js" -}}
  {{ $lazySizes := $lazySizes | js.Build -}}
  {{ $slice = $slice | append $lazySizes -}}
{{ end -}}

{{ if .Site.Params.options.clipBoard -}}
  {{ $clipBoard := resources.Get "js/clipboard.js" -}}
  {{ $clipBoard := $clipBoard | js.Build -}}
  {{ $slice = $slice | append $clipBoard -}}
{{ end -}}

{{ if .Site.Params.options.instantPage -}}
  {{ $instantPage := resources.Get "js/instant.page.js" -}}
  {{ $instantPage := $instantPage | js.Build -}}
  {{ $slice = $slice | append $instantPage -}}
{{ end -}}

{{ if .Site.Params.options.flexSearch -}}
  {{ $flexSearch := resources.Get "js/vendor/flexsearch/dist/flexsearch.bundle.js" -}}
  {{ $slice = $slice | append $flexSearch -}}
{{ end -}}

{{ if .Site.Params.options.darkMode -}}
  {{ $darkMode := resources.Get "js/darkmode.js" -}}
  {{ $darkMode := $darkMode | js.Build -}}
  {{ $slice = $slice | append $darkMode -}}
{{ end -}}

{{ if .Site.Params.alertDismissable -}}
  {{ $alert := resources.Get "js/alert.js" -}}
  {{ $alert := $alert | js.Build -}}
  {{ $slice = $slice | append $alert -}}
{{ end -}}

{{ if .Site.Params.options.kaTex -}}
  {{ $katexConfig := resources.Get "js/katex.js" -}}
  {{ $katexConfig := $katexConfig | js.Build -}}
  {{ $slice = $slice | append $katexConfig -}}
{{ end -}}

{{ $js := $slice | resources.Concat "main.js" -}}

{{ if eq (hugo.Environment) "development" -}}
  {{ if .Site.Params.options.bootStrapJs -}}
    <script src="{{ $bs.RelPermalink }}" defer></script>
  {{ end -}}
  {{ if .Site.Params.options.highLight -}}
    <script src="{{ $highlight.RelPermalink }}" defer></script>
  {{ end -}}
  {{ if .Site.Params.options.kaTex -}}
    <script src="{{ $katex.RelPermalink }}" defer></script>
    <script src="{{ $katexAutoRender.RelPermalink }}" onload="renderMathInElement(document.body);" defer></script>
  {{ end -}}
  <script src="{{ $js.RelPermalink }}" defer></script>
  {{ with .Params.mermaid -}}
    <script src="{{ $mermaid.RelPermalink }}" defer></script>
  {{ end -}}
  {{ if and (.Site.Params.options.flexSearch) (or (not .IsHome) (in "actualite annuaire blog comment_participer communaute devenir_membre form_association form_collectif form_focel inscription_newsletter rubriques" .Section)) -}}
    <script src="{{ $index.RelPermalink }}" defer></script>
  {{ end -}}
  {{ if and (not .IsHome)  (in "devenir_membre form_association form_collectif form_focel" .Section) -}}
    <script src="https://cdn.form.io/formiojs/formio.full.js"></script>
  {{ end -}}
{{ else -}}
  {{ $js := $js | minify | fingerprint "sha512" -}}
  {{ $index := $index | minify | fingerprint "sha512" -}}
  {{ $bs := $bs | minify | fingerprint "sha512" -}}
  {{ $highlight := $highlight | minify | fingerprint "sha512" -}}
  {{ $katex := $katex | minify | fingerprint "sha512" -}}
  {{ $katexAutoRender := $katexAutoRender | minify | fingerprint "sha512" -}}
  {{ $mermaid := $mermaid | minify | fingerprint "sha512" -}}
  {{ if .Site.Params.options.bootStrapJs -}}
    <script src="{{ $bs.RelPermalink }}" integrity="{{ $bs.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ end -}}
  {{ if .Site.Params.options.highLight -}}
    <script src="{{ $highlight.RelPermalink }}" integrity="{{ $highlight.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ end -}}
  {{ if .Site.Params.options.kaTex -}}
    <script src="{{ $katex.RelPermalink }}" integrity="{{ $katex.Data.Integrity }}" crossorigin="anonymous" defer></script>
    <script src="{{ $katexAutoRender.RelPermalink }}" integrity="{{ $katexAutoRender.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ end -}}
  <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ with .Params.mermaid -}}
    <script src="{{ $mermaid.RelPermalink }}" integrity="{{ $mermaid.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ end -}}
  {{ if and (.Site.Params.options.flexSearch) (or (not .IsHome) (in "actualite annuaire blog comment_participer communaute devenir_membre form_association form_collectif form_focel inscription_newsletter rubriques" .Section)) -}}
    <script src="{{ $index.Permalink }}" integrity="{{ $index.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ end -}}
  {{ if and (not .IsHome)  (in "devenir_membre form_association form_collectif form_focel" .Section) -}}
    <script src="https://cdn.form.io/formiojs/formio.full.min.js"></script>
  {{ end -}}
{{ end -}}

{{ if and (not .IsHome)  (in "devenir_membre form_association form_collectif form_focel" .Section) -}}
<script type="text/javascript">
  window.onload = function() {
    Formio.createForm(
      document.getElementById("formio"),
{{ if (eq "form_association" .Section) -}}
      "https://efulrmjqvqsnulb.form.io/formulaireassociations",
{{ else if (eq "form_collectif" .Section) -}}
      "https://efulrmjqvqsnulb.form.io/formulairecollectifs",
{{ else if (eq "form_focel" .Section) -}}
      "https://efulrmjqvqsnulb.form.io/formulaireprojetslafocel",
{{ else -}}
      "https://efulrmjqvqsnulb.form.io/devenir-membre",
{{ end -}}
      {
        i18n: {
          fr: {
            'error': 'Une erreur a été détectée',
            'Unauthorized': 'Non autorisé. Un formulaire ne peut être envoyé qu\'une seule fois.',
            'Please fix the following errors before submitting.': 'Les erreurs suivantes doivent être corrigées.',
            'Please check the form and correct all errors before submitting.': 'Vérifiez le formulaire et corrigez toutes les erreurs avant d\'envoyer.',
          }
        }
      }
    ).then((form) => {
      form.language = 'fr';
      form.on('submitDone', function(submission) {
{{ if (eq "form_association" .Section) -}}
          window.location = '/form_association/succes/';
{{ else if (eq "form_association" .Section) -}}
          window.location = '/form_collectif/succes/';
{{ else if (eq "form_focel" .Section) -}}
          window.location = '/form_focel/succes/';
{{ else -}}
          window.location = '/devenir_membre/succes/';
{{ end -}}
      });
    });
  };
</script>
{{ end -}}

<script defer data-domain="lesbacots.org" src="https://plausible.quanti.org/js/plausible.js"></script>
